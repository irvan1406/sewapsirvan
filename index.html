<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sewa PS3 IRVAN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .timer-glow { text-shadow: 0 0 20px rgba(34, 197, 94, 0.5); }
        .btn-primary { transition: all 0.3s ease; background: linear-gradient(135deg, #22c55e, #16a34a); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- NAV BAR -->
    <nav class="p-4 glass-card sticky top-0 z-50 flex justify-between items-center mb-6">
        <h1 class="text-xl font-bold tracking-tighter text-green-500">PS3 IRVAN</h1>
        <div class="flex gap-4 text-sm font-medium">
            <button onclick="showPage('user')" class="hover:text-green-400">Sewa</button>
            <button onclick="showPage('admin-login')" class="hover:text-green-400">Admin</button>
        </div>
    </nav>

    <div class="container mx-auto px-4 pb-20 max-w-2xl">
        
        <!-- PAGE: USER FORM (INDEX) -->
        <section id="page-user" class="animate-fadeIn">
            <div class="glass-card p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-gamepad text-green-500"></i> Form Penyewaan
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-1 opacity-70">Nama Penyewa</label>
                        <input type="text" id="cust-name" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Masukkan nama Anda">
                    </div>
                    
                    <div>
                        <label class="block text-sm mb-1 opacity-70">No. WhatsApp (Aktif)</label>
                        <input type="number" id="cust-wa" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="628123456xxxx">
                    </div>

                    <div>
                        <label class="block text-sm mb-1 opacity-70">Pilih Paket Sewa</label>
                        <select id="cust-package" onchange="calculateTotal()" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-green-500 outline-none">
                            <option value="6">6 Jam - Rp 30.000</option>
                            <option value="12">12 Jam - Rp 50.000</option>
                            <option value="24">24 Jam - Rp 80.000</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-lg">
                        <input type="checkbox" id="cust-proyektor" onchange="calculateTotal()" class="w-5 h-5 accent-green-500">
                        <label for="cust-proyektor" class="text-sm">Tambah Proyektor (+ Rp 15.000)</label>
                    </div>

                    <div class="p-4 bg-slate-900 rounded-xl border border-dashed border-slate-700">
                        <label class="block text-sm mb-2 font-bold text-green-400">Metode Pembayaran</label>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <input type="radio" name="pay" value="Cash" checked> <span>Cash (Bayar di Tempat)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="radio" name="pay" value="Transfer BRI"> <span>Transfer BRI</span>
                            </div>
                            <div class="ml-6 text-xs opacity-60">
                                611901029752532 a.n IRVAN MAULANA
                            </div>
                        </div>
                    </div>

                    <div class="flex items-start gap-2 text-xs opacity-70 mt-4">
                        <input type="checkbox" id="rules-check" class="mt-1 accent-green-500">
                        <label for="rules-check">Saya setuju dengan syarat & aturan penyewaan PS3 IRVAN.</label>
                    </div>

                    <div class="mt-6 pt-4 border-t border-slate-700">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-lg">Total Bayar:</span>
                            <span id="total-display" class="text-2xl font-bold text-green-400">Rp 30.000</span>
                        </div>
                        <button onclick="submitSewa()" class="w-full btn-primary p-4 rounded-xl font-bold text-white uppercase tracking-wider">
                            Konfirmasi Sewa & Hubungi Admin
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- PAGE: ADMIN LOGIN -->
        <section id="page-admin-login" class="hidden animate-fadeIn">
            <div class="glass-card p-8 rounded-2xl max-w-sm mx-auto text-center">
                <i class="fas fa-lock text-4xl text-green-500 mb-4"></i>
                <h2 class="text-xl font-bold mb-4">Akses Admin</h2>
                <input type="password" id="admin-pin" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-center text-2xl tracking-widest mb-4" placeholder="••••">
                <button onclick="checkAdminPin()" class="w-full btn-primary p-3 rounded-lg font-bold">MASUK</button>
            </div>
        </section>

        <!-- PAGE: ADMIN DASHBOARD -->
        <section id="page-admin-dashboard" class="hidden animate-fadeIn space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-2xl font-bold">Daftar Penyewa</h2>
                <button onclick="logoutAdmin()" class="text-xs bg-red-500/20 text-red-400 px-3 py-1 rounded">Logout</button>
            </div>
            <div id="admin-list" class="space-y-4">
                <!-- List data dari Firebase akan muncul di sini -->
                <div class="text-center py-10 opacity-50">Mengambil data...</div>
            </div>
        </section>

        <!-- PAGE: TIMER VIEW (PUBLIC) -->
        <section id="page-timer" class="hidden animate-fadeIn text-center">
            <div id="timer-content">
                <!-- Konten timer dinamis -->
            </div>
        </section>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        // CONFIGURASI FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAh0-rM-TD72TMcGg1XRRfOlLLGQOrYGwQ",
            authDomain: "sewaps3.firebaseapp.com",
            projectId: "sewaps3",
            storageBucket: "sewaps3.firebasestorage.app",
            messagingSenderId: "619862500456",
            appId: "1:619862500456:web:adec006e554666f0bc07dd",
            measurementId: "G-HF4971DBQP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "sewa-ps3-irvan-001"; // ID unik untuk namespace firestore

        // AUTHENTICATION
        signInAnonymously(auth).catch(e => console.error("Auth Error", e));

        // GLOBAL STATE
        window.activePage = 'user';
        window.isAdmin = false;
        const ADMIN_PIN = "4321";

        // UTILS: Navigasi
        window.showPage = (pageId) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            window.activePage = pageId;

            // Jika ke halaman timer publik, cek URL params
            const params = new URLSearchParams(window.location.search);
            const timerId = params.get('id');
            if (pageId === 'timer' && timerId) {
                loadTimerView(timerId);
            }
        };

        // USER: Hitung Total
        window.calculateTotal = () => {
            const pkg = parseInt(document.getElementById('cust-package').value);
            const proyektor = document.getElementById('cust-proyektor').checked;
            let total = 0;
            if (pkg === 6) total = 30000;
            else if (pkg === 12) total = 50000;
            else if (pkg === 24) total = 80000;

            if (proyektor) total += 15000;
            document.getElementById('total-display').innerText = `Rp ${total.toLocaleString('id-ID')}`;
            return total;
        };

        // USER: Submit Sewa
        window.submitSewa = async () => {
            const name = document.getElementById('cust-name').value;
            const wa = document.getElementById('cust-wa').value;
            const pkg = document.getElementById('cust-package').value;
            const proyektor = document.getElementById('cust-proyektor').checked;
            const payment = document.querySelector('input[name="pay"]:checked').value;
            const rules = document.getElementById('rules-check').checked;

            if (!name || !wa) return alert("Mohon lengkapi Nama dan No WhatsApp!");
            if (!rules) return alert("Anda harus menyetujui aturan!");

            const total = calculateTotal();
            
            try {
                const docRef = await addDoc(collection(db, "artifacts", appId, "public", "data", "sewa"), {
                    nama: name,
                    wa: wa,
                    paket: pkg,
                    proyektor: proyektor,
                    pembayaran: payment,
                    total: total,
                    status: "Belum Dibayar",
                    createdAt: serverTimestamp(),
                    timerStart: null,
                    timerEnd: null,
                    isRunning: false,
                    note: ""
                });

                const text = `Halo Admin Irvan, saya mau sewa PS3.%0A%0ANama: ${name}%0APaket: ${pkg} Jam%0AProyektor: ${proyektor ? 'Ya' : 'Tidak'}%0ATotal: Rp ${total.toLocaleString('id-ID')}%0ABayar via: ${payment}%0A%0AMohon konfirmasi pembayarannya ya.`;
                window.open(`https://wa.me/6287745756269?text=${text}`, '_blank');
                
                alert("Data berhasil dikirim! Silakan chat admin via WhatsApp.");
                location.reload();

            } catch (e) {
                console.error(e);
                alert("Gagal menyimpan data.");
            }
        };

        // ADMIN: Login Logic
        window.checkAdminPin = () => {
            const pin = document.getElementById('admin-pin').value;
            if (pin === ADMIN_PIN) {
                window.isAdmin = true;
                showPage('admin-dashboard');
                loadAdminData();
            } else {
                alert("PIN Salah!");
            }
        };

        window.logoutAdmin = () => {
            window.isAdmin = false;
            showPage('user');
        };

        // ADMIN: Load Data Real-time
        const loadAdminData = () => {
            const q = query(collection(db, "artifacts", appId, "public", "data", "sewa"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('admin-list');
                listEl.innerHTML = '';
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    const card = document.createElement('div');
                    card.className = "glass-card p-4 rounded-xl border-l-4 " + (data.status === 'Aktif' ? 'border-green-500' : 'border-yellow-500');
                    
                    const timerStatus = data.isRunning ? 
                        `<span class="text-xs bg-green-500 text-white px-2 py-1 rounded">Running</span>` : 
                        `<span class="text-xs bg-slate-600 text-white px-2 py-1 rounded">Stopped</span>`;

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-lg">${data.nama}</h3>
                                <p class="text-xs opacity-60">${data.paket} Jam • ${data.pembayaran} • ${data.proyektor ? '+ Proyektor' : 'Tanpa Proyektor'}</p>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-green-400">Rp ${data.total?.toLocaleString('id-ID')}</div>
                                <div class="text-[10px] uppercase">${data.status}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-4">
                            <button onclick="updateStatus('${id}', 'Aktif')" class="bg-blue-600 text-[10px] p-2 rounded font-bold uppercase">Konfirmasi Bayar</button>
                            <button onclick="copyTimerLink('${id}')" class="bg-purple-600 text-[10px] p-2 rounded font-bold uppercase">Copy Link Timer</button>
                        </div>

                        <div class="mt-4 p-3 bg-slate-900/50 rounded-lg space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs">Control Timer: ${timerStatus}</span>
                                <div class="flex gap-2">
                                    <button onclick="controlTimer('${id}', 'start', ${data.paket})" class="text-green-500 text-sm"><i class="fas fa-play"></i></button>
                                    <button onclick="controlTimer('${id}', 'stop')" class="text-red-500 text-sm"><i class="fas fa-stop"></i></button>
                                    <button onclick="controlTimer('${id}', 'add')" class="text-yellow-500 text-sm"><i class="fas fa-plus-circle"></i> 1j</button>
                                </div>
                            </div>
                            <input type="text" value="${data.note || ''}" onchange="updateNote('${id}', this.value)" placeholder="Catatan Admin..." class="w-full bg-slate-800 border-none text-xs p-2 rounded">
                            <button onclick="deleteData('${id}')" class="w-full text-[10px] text-red-400 opacity-50 hover:opacity-100">Hapus Data</button>
                        </div>
                    `;
                    listEl.appendChild(card);
                });
            }, (err) => console.error("Firestore Error", err));
        };

        // ADMIN: ACTIONS
        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "sewa", id), { status: status });
        };

        window.updateNote = async (id, note) => {
            await updateDoc(doc(db, "artifacts", appId, "public", "data", "sewa", id), { note: note });
        };

        window.deleteData = async (id) => {
            if(confirm("Hapus data ini?")) {
                await deleteDoc(doc(db, "artifacts", appId, "public", "data", "sewa", id));
            }
        };

        window.copyTimerLink = (id) => {
            const url = `${window.location.origin}${window.location.pathname}?page=timer&id=${id}`;
            const dummy = document.createElement("input");
            document.body.appendChild(dummy);
            dummy.value = url;
            dummy.select();
            document.execCommand("copy");
            document.body.removeChild(dummy);
            alert("Link Timer Berhasil Disalin!");
        };

        window.controlTimer = async (id, action, hours = 0) => {
            const docRef = doc(db, "artifacts", appId, "public", "data", "sewa", id);
            const snap = await getDoc(docRef);
            const data = snap.data();

            if (action === 'start') {
                const now = Date.now();
                const end = now + (hours * 3600 * 1000);
                await updateDoc(docRef, { 
                    timerStart: now, 
                    timerEnd: end, 
                    isRunning: true,
                    status: 'Aktif'
                });
            } else if (action === 'stop') {
                await updateDoc(docRef, { isRunning: false, timerEnd: Date.now() });
            } else if (action === 'add') {
                const newEnd = (data.timerEnd || Date.now()) + (1 * 3600 * 1000);
                await updateDoc(docRef, { timerEnd: newEnd });
            }
        };

        // TIMER VIEW: Real-time Countdown
        window.loadTimerView = (id) => {
            const docRef = doc(db, "artifacts", appId, "public", "data", "sewa", id);
            onSnapshot(docRef, (snap) => {
                const container = document.getElementById('timer-content');
                if (!snap.exists()) {
                    container.innerHTML = `<div class="p-10">Data tidak ditemukan atau sudah dihapus.</div>`;
                    return;
                }

                const data = snap.data();
                container.innerHTML = `
                    <div class="py-10">
                        <h1 class="text-3xl font-bold text-green-500 mb-2">PS3 IRVAN</h1>
                        <p class="opacity-70 mb-8">Penyewa: <span class="font-bold text-white">${data.nama}</span></p>
                        
                        <div class="glass-card py-12 rounded-3xl mb-8">
                            <div id="countdown-display" class="text-6xl md:text-8xl font-black timer-glow font-mono">
                                00:00:00
                            </div>
                            <p class="mt-4 text-sm tracking-widest uppercase opacity-50">Sisa Waktu</p>
                        </div>

                        ${data.note ? `<div class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl mb-6">
                            <p class="text-sm text-yellow-400 italic">" ${data.note} "</p>
                        </div>` : ''}

                        <div class="text-xs opacity-40">
                            Status: ${data.isRunning ? 'Sedang Berjalan' : 'Berhenti'} <br>
                            Paket: ${data.paket} Jam
                        </div>
                    </div>
                `;

                // Start Interval
                if (window.timerInterval) clearInterval(window.timerInterval);
                
                const updateDisplay = () => {
                    const display = document.getElementById('countdown-display');
                    if (!display) return;

                    if (!data.isRunning) {
                        display.innerText = "OFF";
                        display.classList.add('text-slate-600');
                        return;
                    }

                    const now = Date.now();
                    const distance = data.timerEnd - now;

                    if (distance < 0) {
                        display.innerText = "HABIS";
                        display.classList.add('text-red-500');
                        return;
                    }

                    const h = Math.floor(distance / (1000 * 60 * 60));
                    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((distance % (1000 * 60)) / 1000);

                    display.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                };

                updateDisplay();
                window.timerInterval = setInterval(updateDisplay, 1000);

            });
        };

        // HANDLE DEEP LINKS (URL Params)
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('page') === 'timer' && params.get('id')) {
                showPage('timer');
            } else {
                showPage('user');
            }
        };

    </script>
</body>
</html>
